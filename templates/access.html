<link rel="stylesheet" href="/access/css/access.css">

<div id="access" class="section-profile">
  <div class="row">
    <div class="topleft duk-icon"><img onclick="removeSection('access')" src="/gui/img/x.png"></div>
    <div id="access-sidebar" class="column section-border" style="flex:25%;">
      <img src="/access/img/access.png">
      <h4 style="margin-bottom:-5px">Access</h4>
      <p class="section-description">
          Here you'll find exploits which are designed to initiate access on a remote
          host or execute pre-ATT&CK abilities. Select an agent to run the exploit and the ability itself to fill in the
          details associated to it. To the right, you'll see every ability tasked to an agent, outside the scope of an
          operation. Click the &#9733; to view the output of any exploit.
      </p>
      <select id="access-pets" onchange="refresh();populateExploits()">
        <option disabled selected>Choose a runner</option>
        {% for a in agents %}
            <option value={{ a.paw }} data-executors={{ a.executors }}>{{ a.host }} - {{ a.paw }}</option>
        {% endfor %}}
      </select>
      <select id="access-exploits" onchange="showProperties()">
          <option disabled='disabled' selected>-- select an ability --</option>
      </select>
      <br>
      <button id="exploitExploit" type="button" class="button-success atomic-button" onclick="runExploit()">Run</button>
    </div>
    <div class="column" style="flex:75%">
        <ul id="exploits" class="profile-tests"></ul>
    </div>
  </div>
</div>

<li id="exploit-template" class="exploit-box" style="display: none">
    <center>
        <div class="exploit-banner">
            <p id="exploit-tactic"></p>
        </div>
        <img id="exploit-image"/>
        <p id="exploit-status"></p>
        <h4 id="exploit-name"></h4>
        <p id="exploit-result">&nbsp;</p>
    </center>
</li>

<div id="properties-modal" class="modal">
    <form class="modal-content" style="width:90%;">
        <div class="container modal-box">
            <div class="row ability-viewer">
                <div class="column" style="flex:100%">
                    <center>
                        <p style="text-align: center;font-size:11px;margin-top:-10px;margin-bottom:25px">
                            Please review the exploit details and click OK. Ensure all properties have valid values (replace the dashes).
                        </p>
                        <h4 id="exploit-description" style="margin-top:2px;text-align:center"></h4>
                        <ul id="exploit-properties"></ul>
                    </center>
                    <div class="div-button" onclick="document.getElementById('properties-modal').style.display='none'">OK</div>
                </div>
            </div>
        </div>
    </form>
</div>

<li id="property-template" class="row-simple" style="display: none;list-style-type:none">
    <table class="obfuscation-table" border=1 rules=rows>
        <tr>
            <td style="width:50%"><p id="exploit-trait"></p></td>
            <td style="width:50%"><p id="exploit-value" contenteditable="true">-</p></td>
        </tr>
    </table>
</li>

<script>
    $(document).ready(function () {
        stream('Deploy an agent locally to conduct initial access... or remotely to disguise your attacks');
    });

    let refresher = setInterval(refresh, 10000);
    $('.section-profile').bind('destroyed', function() {
        clearInterval(refresher);
    });

    function refresh(){
        function refreshCallback(data){
            $('#exploits').empty();
            data[0].links.forEach(function(link) {
                let template = $("#exploit-template").clone();
                template.find('#exploit-tactic').text(link.ability.tactic);
                template.find('#exploit-name').text(link.ability.name);
                if (link.status === 0) {
                    template.find('#exploit-status').text('SUCCESS');
                    template.find('#exploit-image').attr('src', '/access/img/unlocked.png');
                    if(link.output)
                        template.find('#exploit-result').html('&#9733;').click(function(){
                            fetchResult(link);
                        });
                } else if (link.status > 0) {
                    template.find('#exploit-status').text('FAILED');
                    template.find('#exploit-image').attr('src', '/access/img/locked.png');
                    if(link.output)
                        template.find('#exploit-result').html('&#9733;').click(function(){
                            fetchResult(link);
                        });
                } else {
                    template.find('#exploit-status').text('IN-PROGRESS');
                    template.find('#exploit-image').attr('src', '/access/img/progress-lock.png');
                }
                template.show();
                $('#exploits').append(template);
            });
        }
        let paw = $('#access-pets option:selected').attr('value');
        if(paw != null) {
            restRequest('POST', {'index':'agents', 'paw': paw}, refreshCallback);
        }
    }

    function showProperties(){
        function propertiesCallback(data){
            let cmd = atob(data[0].test);
            let found = [], rxp = /{([^}]+)}/g, str = cmd, curMatch;
            while(curMatch = rxp.exec(str)) {
                found.push(curMatch[1]);
            }
            $('#exploit-properties').empty();
            $('#exploit-description').text(data[0].description);

            found.forEach(function(prop){
                let template = $("#property-template").clone();
                template.find('#exploit-trait').text(prop);
                template.show();
                $('#exploit-properties').append(template);
            });
            document.getElementById("properties-modal").style.display = "block";
        }
        let ability_id = $('#access-exploits option:selected').attr('value');
        restRequest('POST', {'index':'abilities', 'ability_id': ability_id}, propertiesCallback);
    }

    function runExploit(){
      function runExploitCallback(data){
          stream('Exploit tasked!');
          refresh();
      }
      let ability_id = $('#access-exploits option:selected').attr('value');
      let facts = [];
      $("#exploit-properties tr").each(function () {
            let trait = $(this.cells[0]).text();
            let value = $(this.cells[1]).text();
            facts.push({'trait':trait,'value':value});
      });
      let paw = $('#access-pets option:selected').attr('value');
      if(paw == null || ability_id == null) {
          alert('Missing requirement!');
      } else {
          let data = {'paw': paw, 'ability_id': ability_id, 'facts': facts};
          restRequest('POST', data, runExploitCallback, '/plugin/access/exploit');
      }
    }

    function fetchResult(link) {
        let modal = $('#alert-text');
        function loadResult(data) {
            document.getElementById('alert-modal').style.display='block';
            modal.html('<pre>'+atob(data.output)+'</pre>');
        }
        modal.html('');
        restRequest('POST', {'index':'result','link_id':link.unique}, loadResult);
    }

    function populateExploits(){
        let exploitList = $('#access-exploits');
        function appendAbilities(data) {
            exploitList.empty();
            data.forEach(function(ability){
                exploitList.append($("<option></option>")
                    .attr("value", ability['ability_id'])
                    .text(ability['name']));
            });
            exploitList.prepend("<option disabled='disabled' selected>-- select an ability --</option>");
        }
        let paw = $('#access-pets option:selected').attr('value');
        restRequest('POST', {'paw':paw}, appendAbilities, '/plugin/access/abilities');
    }
</script>