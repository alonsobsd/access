<div id="access" class="section-profile">
  <div class="row">
    <div class="topleft duk-icon"><img onclick="removeSection('access')" src="/gui/img/x.png"></div>
    <div id="access-sidebar" class="column section-border" style="flex:25%;">
      <img src="/access/img/access.png">
      <h4 style="margin-bottom:-5px">Access</h4>
      <p class="section-description">
          Here you'll find exploits which are designed to initiate access on a remote
          host. Select an agent to run the exploit, the exploit itself and a target agent to deploy, if successful.
          Most exploits require a few properties to fill in - so fill these in.
      </p>
      <select id="access-pets">
        <option disabled selected>Choose a runner</option>
        {% for a in agents %}
            <option value={{ a.paw }}>{{ a.host }}</option>
        {% endfor %}}
      </select>
      <select id="access-exploits" onchange="showProperties()">
        <option disabled selected>Choose an exploit</option>
        {% for k, v in exploits.items() %}
            <option value={{ k }}>{{ v }}</option>
        {% endfor %}}
      </select>
      <select id="access-targets">
        <option disabled selected>Choose a target</option>
        {% for k, v in targets.items() %}
            <option value={{ k }}>{{ v }}</option>
        {% endfor %}}
      </select>
      <br><br>
      <div>
        <i><p id="exploit-description" style="margin-right:20px;"></p></i>
        <table id="exploit-properties" class="obfuscation-table" border=1 frame=void rules=rows></table>
      </div>
      <br>
      <button id="exploitExploit" type="button" class="button-success atomic-button" onclick="runExploit()">Exploit</button>

    </div>
    <div class="column" style="flex:75%">

    </div>
  </div>
</div>

<script>
    let refresher = setInterval(refresh, 10000);
    $('.section-profile').bind('destroyed', function() {
        clearInterval(refresher);
    });

    function refresh(){
        function refreshCallback(data){
            console.log(data);
        }
        let paw = $('#access-pets option:selected').attr('value');
        if(paw !== null) {
            restRequest('POST', {'index':'agents', 'paw': paw}, refreshCallback);
        }
    }

    function showProperties(){
        function propertiesCallback(data){
            let cmd = atob(data[0].test);
            let found = [], rxp = /{([^}]+)}/g, str = cmd, curMatch;
            while(curMatch = rxp.exec(str)) {
                found.push(curMatch[1]);
            }
            $('#exploit-properties').empty();
            $('#exploit-description').text(data[0].description);

            found.forEach(function(prop){
                $('#exploit-properties').append('<tr><td style="font-size:12px;"><b>'+prop+'</b></td><td contenteditable="true" style="font-size:12px">Required value</td></tr>');
            });
        }
        let ability_id = $('#access-exploits option:selected').attr('value');
        restRequest('POST', {'index':'abilities', 'ability_id': ability_id}, propertiesCallback);
    }

    function runExploit(){
      function runExploitCallback(data){
          stream('Exploit tasked!');
      }
      let ability_id = $('#access-exploits option:selected').attr('value');
      let facts = [];
      $("#exploit-properties tr").each(function () {
            let trait = $(this.cells[0]).text();
            let value = $(this.cells[1]).text();
            facts.push({'trait':trait,'value':value});
      });
      let paw = $('#access-pets option:selected').attr('value');
      let target = $('#access-targets option:selected').attr('value');
      if(paw == null || target == null || ability_id == null) {
          alert('Missing requirement!');
      } else {
          let data = {'paw': paw, 'target': target, 'ability_id': ability_id, 'facts': facts};
          restRequest('POST', data, runExploitCallback, '/plugin/access/exploit');
      }
    }
</script>